{% extends "general.html" %} {% block title %} My files {% endblock %} {% block
content %}

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  main {
    display: flex;
    flex-direction: column;
  }

  header {
    margin-top: 1rem;
  }

  .droparea {
    width: 384px;
    max-width: 100%;
    height: 160px;
    border: 4px dashed grey;
    border-radius: 15px;
  }

  .selectarea {
    background-color: #292b2c;
  }
</style>
<div class="container d-flex align-items-center justify-content-around my-5">
  <div class="d-flex justify-content-center pt-3">
    <h1 class="display-3 text-white">My files</h1>
  </div>
  <section class="d-flex align-items-center justify-content-center droparea">
    <p class="text-white lead user-select-none" id="section-text">
      Drop file to the lab ðŸ”¬
    </p>
  </section>
</div>
<ul class="d-flex flex-wrap gap-5" id="files-list">
  <li style="width: 70px" id="filetemplate" hidden>
    <div class="d-flex align-items-center card bg-transparent border-0">
      <img
        id="filetemplate-img"
        class="card-img-top"
        src="static/images/extension_icons/_blank.png"
      />
      <div class="card-body">
        <p
          class="card-text text-white lead overflow-auto"
          style="font-size: 15px"
          id="filetemplateText"
        >
          filename.txt
        </p>
      </div>
    </div>
  </li>
</ul>
<script>
  // thanks to https://www.youtube.com/watch?v=9Xh_ZpFkROI
  const getImageByName = (filename) => {};

  const initApp = () => {
    const droparea = document.querySelector(".droparea");

    // Color border
    const active = () => {
      droparea.classList.add("selectarea");
      document.getElementById("section-text").innerHTML = "right here buddy";
    };

    const inactive = () => {
      droparea.classList.remove("selectarea");
      document.getElementById("section-text").innerHTML =
        "Drop file to the lab ðŸ”¬";
    };

    // Prevent default reload for all file-related events
    const prevents = (e) => e.preventDefault();
    ["dragenter", "dragover", "dragleave", "drop"].forEach((evtName) => {
      droparea.addEventListener(evtName, prevents);
    });

    ["dragenter", "dragover"].forEach((evtName) => {
      droparea.addEventListener(evtName, active);
    });

    ["dragleave", "drop"].forEach((evtName) => {
      droparea.addEventListener(evtName, inactive);
    });

    droparea.addEventListener("drop", handleDrop);
  };

  document.addEventListener("DOMContentLoaded", initApp);

  const handleDrop = (e) => {
    const dt = e.dataTransfer;
    const files = [...dt.files];

    for (const file of files) {
      var reader = new FileReader();
      const name = file.name;
      reader.readAsArrayBuffer(file);
      reader.onload = (evt) => {
        const content = evt.target.result;
        // Here we got content and name to send
        formData = new FormData();
        formData.append("file", new Blob([content]), name);

        $(document).ready(() => {
          $.ajax({
            url: "/files",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: (res) => {
              const filesList = document.getElementById("files-list");
              // Copy hidden list item into li
              const li = document
                .getElementById("filetemplate")
                .cloneNode(true);
              li.hidden = false;

              li.querySelectorAll('[id="filetemplateText"]')[0].innerHTML =
                name;

              li.querySelectorAll(
                '[id="filetemplate-img"]'
              )[0].src = `data:image/png;base64, ${res}`;
              // li.textContent = returnedFilename;
              filesList.appendChild(li);
            },
          });
        });
      };
      reader.onerror = (err) => {
        console.log(err);
      };
    }
  };
</script>
{% endblock %}
